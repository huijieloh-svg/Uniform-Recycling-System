<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    <style>
      :root {
  --item-photo-height: 260px; /* <-- 調整這裡來改照片固定高度（HOME 與 Detail Modal 同尺寸） */
}

/* Ensure grid cards have uniform image area */
.card-photo-box {
  width: 100%;
  height: var(--item-photo-height); /* fixed height */
  background-color: #f0f0f0;
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
}
.card-photo-box img {
  width: 100%;
  height: 100%;
  object-fit: cover; /* crop to fill */
  display: block;
}

/* Detail modal left photo frame uses same size as cards */
.detail-photo .photo-frame {
  width: 100%;
  height: var(--item-photo-height); /* same fixed height */
  background:#f2f4f6;
  border-radius: 12px;
  border: 2px solid #dfe7ef;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow: hidden;
  position: relative;
}
.detail-photo .photo-frame img.main-photo {
  width: 100%;
  height: 100%;
  object-fit: cover;
  cursor: zoom-in; /* indicate clickable to fullscreen */
}

/* Fullscreen viewer overlay */
#fullscreen-image-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.95);
  z-index: 5000;
  display: none;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}
#fullscreen-image-overlay .fs-img {
  max-width: 98%;
  max-height: 98%;
  object-fit: contain;
  display:block;
  margin: 0 auto;
  transition: transform 0.18s ease;
}
.fs-close, .fs-prev, .fs-next {
  position: absolute;
  top: 18px;
  background: rgba(0,0,0,0.45);
  color: #fff;
  border: none;
  padding: 8px 10px;
  border-radius: 6px;
  cursor: pointer;
  z-index: 5010;
}
.fs-close { right: 18px; }
.fs-prev { left: 18px; top: 50%; transform: translateY(-50%); padding:12px; border-radius:50%; }
.fs-next { right: 18px; top: 50%; transform: translateY(-50%); padding:12px; border-radius:50%; }

/* small hint for touch */
#fullscreen-image-overlay .fs-hint { position:absolute; bottom:18px; color:#ddd; font-size:13px; }

/* ensure detail modal layout still fits responsive */
@media (max-width: 880px) {
  :root { --item-photo-height: 220px; } /* adjust on small screens */
}


      /* --- Basic Settings --- */
      body { font-family: 'Roboto', sans-serif; background-color: #f4f6f8; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }

      /* --- Login Card --- */
      .card { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 420px; text-align: center; }
      .app-logo { width: 100px; height: auto; margin-bottom: 20px; display: block; margin-left: auto; margin-right: auto; }
      .brand-title { color: #003366; font-size: 22px; font-weight: 700; margin-bottom: 5px; }
      .brand-subtitle { color: #666; font-size: 16px; margin-bottom: 30px; font-weight: 400; }

      /* --- Input Groups --- */
      .input-group { position: relative; margin-bottom: 20px; text-align: left; }
      .input-group label { display: block; font-size: 14px; color: #666; margin-bottom: 5px; }
      .input-wrapper { position: relative; display: flex; align-items: center; }
      input { width: 100%; padding: 12px; padding-right: 40px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
      .toggle-password { position: absolute; right: 10px; cursor: pointer; color: #777; user-select: none; }

      /* --- Buttons --- */
      button.primary-btn { width: 100%; padding: 12px; background-color: #003366; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: 500; transition: background 0.3s; }
      button.primary-btn:hover { background-color: #002244; }
      .error-msg { color: #d93025; font-size: 14px; margin-bottom: 15px; display: none; }

      /* --- Loading --- */
      #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
      .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #003366; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* --- Modal (General) --- */
      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 2000; display: none; justify-content: center; align-items: center; }
      #modal-overlay { z-index: 2000; } /* Password Change Modal specific */
      
      /* --- Dashboard View --- */
      #dashboard-view { display: none; width: 100%; height: 100%; overflow-y: auto; background-color: #f4f6f8; position: absolute; top: 0; left: 0; }
      .navbar { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: fixed; top: 0; left: 0; right: 0; z-index: 100; }
      .nav-left { display: flex; align-items: center; gap: 15px; }
      .nav-logo { height: 40px; }
      .nav-title { font-weight: 700; color: #003366; font-size: 18px; }
      .nav-menu a { text-decoration: none; color: #666; margin-left: 20px; font-weight: 500; cursor: pointer; padding-bottom: 5px; }
      .nav-menu a.active { color: #003366; border-bottom: 2px solid #003366; }
      .main-content { margin-top: 80px; padding: 20px; max-width: 1200px; margin-left: auto; margin-right: auto; }
      .page-section { display: none; }
      .page-section.active { display: block; }
      .fab-btn { position: fixed; bottom: 40px; right: 40px; width: 60px; height: 60px; background: #003366; color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 35px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 500; }

      /* --- Filter/Search --- */
      .search-row { display:flex; gap:10px; align-items:center; margin-bottom:15px; }
      .search-input { flex:1; display:flex; gap:10px; align-items:center; }
      .filter-btn { padding:8px 12px; background:#fff; border:1px solid #ddd; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:6px; }

      /* NEW: style when the "profile history" buttons are active to match nav-menu active underline */
      .filter-btn.active {
        color: #003366;
        border-bottom: 2px solid #003366;
        background: transparent;
        font-weight: 600;
        box-shadow: none;
      }

      /* Filter panel simplified & nicer */
      #filter-panel {
        display: none;
        margin-bottom: 12px;
        background: #fff;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #eee;
        box-shadow: 0 6px 18px rgba(0,0,0,0.04);
      }
      #filter-panel .row { display:flex; gap:10px; align-items:center; }
      #filter-panel label { font-size:13px; color:#555; display:block; margin-bottom:6px; }
      #filter-panel select { padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fafafa; min-width:120px; }

      /* --- Help Floating Button --- */
      .help-fab { position: fixed; bottom: 110px; right: 40px; width: 56px; height: 56px; background: #00796b; color: white; border-radius: 50%; display:flex; justify-content:center; align-items:center; font-size:26px; cursor:pointer; box-shadow: 0 6px 18px rgba(0,0,0,0.15); z-index: 600; }

      /* --- Add Item Modal --- */
      .modal-box { background: white; width: 90%; max-width: 700px; max-height: 85vh; overflow-y: auto; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; }
      .modal-title { color: #003366; font-size: 24px; font-weight: 700; margin-top: 0; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid #eee; }
      .section-title { color: #444; font-size: 16px; font-weight: 600; margin-top: 30px; margin-bottom: 15px; padding-left: 10px; border-left: 4px solid #003366; background-color: #f9f9f9; padding: 8px 10px; border-radius: 0 4px 4px 0; }
      .form-row { display: flex; gap: 20px; margin-bottom: 20px; }
      .form-col { flex: 1; display: flex; flex-direction: column; }
      .form-col label { font-size: 14px; color: #555; font-weight: 500; margin-bottom: 8px; }
      .form-col input, .form-col select, .form-col textarea { width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; background-color: #fff; box-sizing: border-box; transition: border-color 0.3s; }
      .form-col input:focus, .form-col select:focus, .form-col textarea:focus { border-color: #003366; outline: none; box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1); }
      .radio-group { display: flex; gap: 20px; align-items: center; height: 42px; }
      .radio-item { display: flex; align-items: center; cursor: pointer; }
      .radio-item input { margin-right: 8px; cursor: pointer; accent-color: #003366; width: 18px; height: 18px; }
      #photo-container { border: 2px dashed #ddd; padding: 15px; border-radius: 8px; background-color: #fafafa; min-height: 80px; display: flex; flex-wrap: wrap; gap: 10px; }
      .photo-slot { border: 2px dashed #ccc; padding: 5px; text-align: center; border-radius: 5px; background: #fafafa; width: 120px; }
      .photo-slot.done { border-color: #003366; background: #eef6ff; }
      .photo-slot img { width: 100%; height: 80px; object-fit: cover; display: none; margin-bottom: 5px; }
      .photo-placeholder { height: 80px; background: #222; color: white; display: flex; align-items: center; justify-content: center; font-size: 11px; margin-bottom: 5px; }
      .form-actions { margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; text-align: right; display: flex; justify-content: flex-end; gap: 15px; }
      .btn-cancel { padding: 10px 25px; border: 1px solid #ddd; background: white; color: #666; border-radius: 6px; cursor: pointer; font-size: 14px; }
      .btn-submit { padding: 10px 25px; border: none; background: #003366; color: white; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s; }
      .btn-submit:hover { background: #002244; }

      /* ================= Inventory Grid (Corrected) ================= */
      .inventory-grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr); /* 3 Columns */
          gap: 15px;
          padding: 15px;
          max-width: 1200px; 
          margin: 0 auto;
          box-sizing: border-box;
          width: 100%;
      }

      /* RWD Mobile */
      @media (max-width: 768px) {
          .card { padding: 25px 20px; width: 90%; }
          .app-logo { width: 80px; margin-bottom: 15px; }
          .brand-title { font-size: 20px; }
          .nav-title { display: none; } /* Hide title on mobile nav */
          .form-row { flex-direction: column; gap: 15px; }
          .modal-box { padding: 25px; width: 95%; }
          
          .inventory-grid {
              grid-template-columns: repeat(2, 1fr); /* 2 Columns on Mobile */
              gap: 10px;
              padding: 10px;
          }

          :root { --item-photo-height: 220px; }
      }

      /* --- Item Card --- */
      .item-card {
          background: white;
          border-radius: 8px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.08);
          overflow: hidden;
          cursor: pointer;
          transition: transform 0.2s, box-shadow 0.2s;
          display: flex;
          flex-direction: column;
          position: relative;
          height: 100%;
      }
      .item-card:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.12); }
      
      .card-photo-box {
          width: 100%;
          aspect-ratio: 1 / 1; /* Square Image */
          background-color: #f0f0f0;
          position: relative;
      }
      .card-photo-box img { width: 100%; height: 100%; object-fit: cover; }
      
      .card-code {
          position: absolute;
          top: 6px;
          left: 6px;
          background: rgba(0,0,0,0.6);
          color: white;
          padding: 3px 6px;
          font-size: 12px;
          font-weight: bold;
          border-radius: 4px;
          z-index: 2;
      }

      .card-details { padding: 10px; display: flex; flex-direction: column; gap: 6px; flex-grow: 1; }
      .card-title { font-weight: bold; font-size: 15px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .card-size { font-size: 13px; color: #666; }
      .card-price { color: #d32f2f; font-weight: bold; font-size: 16px; margin-top: 2px; } /* Red Price */
      
      .card-time { display: flex; align-items: center; font-size: 12px; color: #9aa0a6; margin-top: 6px; }
      .time-icon { width: 14px; height: 14px; margin-right: 8px; opacity: 0.9; filter: grayscale(100%); }

/* NEW: footer layout so time and company name are on same line, company at right-bottom */
.card-footer { display:flex; justify-content:space-between; align-items:center; margin-top:6px; gap:8px; }
.card-company-inline { font-weight: bold; font-size:12px; color:#333; text-align:right; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60%; }

      .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; text-align: center; position: relative; }

      /* Small helpers */
      .muted { color:#777; font-size:13px; }
      .tag { display:inline-block; background:#eef6ff; color:#003366; padding:4px 8px; border-radius:6px; font-size:13px; }

.detail-grid {
  display: flex;
  gap: 28px;
  align-items: flex-start;
  padding: 6px 0;
}
.detail-photo {
  flex: 1 1 48%;
  min-width: 260px;
  max-width: 520px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.detail-photo .photo-frame {
  width: 100%;
  aspect-ratio: 4 / 3;
  background:#f2f4f6;
  border-radius: 12px;
  border: 2px solid #dfe7ef;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow: hidden;
  position: relative;
}
.detail-photo img.main-photo {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.carousel-dots {
  display:flex;
  gap:8px;
  justify-content:center;
  align-items:center;
  margin-top:6px;
}
.carousel-dot {
  width:10px;
  height:10px;
  border-radius:50%;
  background:#cfd8e3;
  cursor:pointer;
  box-shadow: 0 1px 0 rgba(0,0,0,0.08) inset;
}
.carousel-dot.active { background:#003366; box-shadow: 0 2px 4px rgba(0,0,0,0.12); }
.detail-photo .detail-prev,
.detail-photo .detail-next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.45);
  color: #fff;
  border: none;
  padding: 10px 12px;
  border-radius: 50%;
  cursor: pointer;
  z-index: 6;
  font-size: 18px;
}
.detail-photo .detail-prev { left: 8px; }
.detail-photo .detail-next { right: 8px; }

/* right column info */
.detail-info {
  flex: 0 1 48%;
  min-width: 240px;
  display:flex;
  flex-direction: column;
  gap: 12px;
  position: relative;
  padding-bottom: 82px; /* leave space for absolute actions */
}
.detail-info .title {
  font-size:20px;
  font-weight:700;
  color:#0b3156;
}
.detail-info .price {
  color:#d32f2f;
  font-weight:800;
  font-size:18px;
  margin-top:4px;
}
.detail-info .meta { color:#444; font-weight:600; margin-top:8px; }
.detail-info .muted { color:#8b96a6; font-size:13px; display:flex; align-items:center; gap:8px; margin-top:8px; }
/* actions moved to be absolute and anchored to detail modal bottom-right */
#detail-box { padding-bottom: 26px; position: relative; } /* ensure enough padding and relative positioning on the box */
#detail-box .actions {
  position: absolute;
  right: 20px;
  bottom: 20px;
  display: flex;
  gap: 12px;
}
.detail-info .btn-cancel { border:1px solid #cfd8e3; background:#fff; padding:8px 16px; border-radius:8px; cursor:pointer; color:#0b3156; }
.detail-info .btn-buy { background:#0072c6; color:#fff; padding:9px 18px; border-radius:8px; border:none; cursor:pointer; }

.detail-info .btn-cancel:hover { background: #f0f4f8; }
.detail-info .btn-buy:hover { background: #005a9e; }

/* small responsive */
@media (max-width: 880px) {
  .detail-grid { flex-direction: column; }
  .detail-photo, .detail-info { flex-basis: 100%; max-width: 100%; }

    </style>
  </head>

  <body>
    <div id="login-view" style="width:100%; display:flex; justify-content:center;">
       <div class="card" id="login-card">
           <img src="https://images.seeklogo.com/logo-png/35/1/the-boys-brigade-logo-png_seeklogo-357493.png" alt="BB Logo" class="app-logo">
           <div class="brand-title">Boys' Brigade</div>
           <div class="brand-title">Uniform Exchange Platform</div>
           <div class="brand-subtitle">Please login to continue</div>
           <div id="login-error" class="error-msg">Username or password is incorrect</div>
           <div class="input-group">
             <label>Username</label>
             <input type="text" id="username" placeholder="Enter Username">
           </div>
           <div class="input-group">
             <label>Password</label>
             <div class="input-wrapper">
               <input type="password" id="password" placeholder="Enter Password">
               <span class="material-icons toggle-password" onclick="toggleVisibility('password', this)">visibility_off</span>
             </div>
           </div>
           <button class="primary-btn" onclick="handleLogin()">Login</button>
       </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
          <h3>First Login - Change Password</h3>
          <p style="font-size:13px; color:#666; margin-bottom:20px;">Password must be at least 7 characters and contain at least one digit.</p>
          <div id="modal-error" class="error-msg"></div>
          <div class="input-group">
             <label>New Password</label>
             <div class="input-wrapper">
               <input type="password" id="new-password">
               <span class="material-icons toggle-password" onclick="toggleVisibility('new-password', this)">visibility_off</span>
             </div>
          </div>
          <div class="input-group">
             <label>Confirm New Password</label>
             <div class="input-wrapper">
               <input type="password" id="confirm-password">
               <span class="material-icons toggle-password" onclick="toggleVisibility('confirm-password', this)">visibility_off</span>
             </div>
          </div>
          <button class="primary-btn" onclick="handleChangePassword()">Confirm Change</button>
        </div>
    </div>
    
    <div id="dashboard-view">
       <div class="navbar">
           <div class="nav-left">
               <img src="https://images.seeklogo.com/logo-png/35/1/the-boys-brigade-logo-png_seeklogo-357493.png" class="nav-logo">
               <div class="nav-title">Boys' Brigade Uniform Exchange Platform</div>
           </div>
           <div class="nav-menu">
               <a onclick="switchTab('home')" id="nav-home" class="active">HOME</a>
               <a onclick="switchTab('profile')" id="nav-profile">PROFILE</a>
               <a onclick="switchTab('about')" id="nav-about">ABOUT US</a>
               <a onclick="switchTab('admin')" id="nav-admin" style="display:none;">ADMIN</a>
           </div>
       </div>

       <div id="home-section" class="main-content page-section active">
           <h3 style="color:#003366; margin-bottom:10px;">Available Uniforms</h3>

           <div class="search-row">
               <div class="search-input">
                   <input id="search-text" type="text" placeholder="Search by code, company, category..." style="padding:10px;border:1px solid #ddd;border-radius:8px;flex:1;">
                   <button id="filter-toggle" class="filter-btn" onclick="toggleFilterPanel()" title="Filters">
                      <span class="material-icons">filter_list</span> Filter
                   </button>
                   <button class="filter-btn" onclick="applyFilters()" title="Search" style="margin-left:6px;">
                      <span class="material-icons">search</span> Search
                   </button>
               </div>
               <div style="margin-left:10px;">
                   <button class="filter-btn" onclick="resetFilters()">Reset</button>
               </div>
           </div>

           <div id="filter-panel">
             <div class="row" style="align-items:flex-end;">
                <div style="flex:1;">
                  <label>Category</label>
                  <select id="filter-category">
                    <option value="">All</option>
                    <option>Shirt</option>
                    <option>Pants</option>
                  </select>
                </div>
                <div style="flex:1;">
                  <label>Size</label>
                  <select id="filter-size">
                    <option value="">All</option>
                    <option>XS</option><option>S</option><option>M</option><option>L</option><option>XL</option><option>2XL</option>
                  </select>
                </div>
                <div style="flex:1;">
                  <label>Type</label>
                  <select id="filter-type">
                    <option value="">All</option>
                    <option>Donate</option>
                    <option>Sell</option>
                  </select>
                </div>
                <div style="display:flex; gap:8px;">
                  <button class="btn-submit" onclick="applyFilters()">Apply</button>
                  <button class="btn-cancel" onclick="toggleFilterPanel()">Close</button>
                </div>
             </div>
           </div>

           <div id="inventory-grid" class="inventory-grid">
               <p>Loading items...</p>
           </div>

           <div class="fab-btn" onclick="openAddModal()">+</div>
           <div class="help-fab" title="Help" onclick="openHelpChat()"><span style="font-weight:700;">?</span></div>
       </div>

       <div id="about-section" class="main-content page-section">
           <h2>About Us</h2><p>Content coming soon...</p>
       </div>

       <div id="profile-section" class="main-content page-section" style="position:relative;">
           <div style="display:flex; align-items:center; justify-content:space-between;">
             <h2 style="margin:0;">My Profile</h2>
             <!-- Hamburger menu moved to page right top -->
             <div style="position:relative;">
               <button id="profile-menu-btn" class="btn-submit" style="padding:8px 10px; background:#fff; color:#0b3156; border:1px solid #cfd8e3; border-radius:8px;" onclick="toggleProfileMenu()">☰</button>
               <div id="profile-menu" style="position:absolute; right:0; top:42px; display:none; background:#fff; border:1px solid #eee; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.12); min-width:220px; z-index:120;">
                 <button style="width:100%; text-align:left; padding:10px; border:none; background:transparent; cursor:pointer;" onclick="triggerChangeProfilePicture()">Change Profile Picture</button>
                 <button style="width:100%; text-align:left; padding:10px; border:none; background:transparent; cursor:pointer;" onclick="openEditProfileModal()">Edit Profile Information</button>
                 <button style="width:100%; text-align:left; padding:10px; border:none; background:transparent; cursor:pointer;" onclick="openChangePasswordModal()">Change Password</button>
                 <button style="width:100%; text-align:left; padding:10px; border:none; background:#d93025; color:#fff; cursor:pointer;" onclick="logout()">Log out</button>
               </div>
             </div>
           </div>

           <div id="profile-content" style="margin-top:12px;">
             <div style="display:flex; gap:20px; align-items:center;">
               <div>
                 <img id="profile-avatar" src="" style="width:120px;height:120px;border-radius:8px;object-fit:cover;background:#eee;">
               </div>
               <div style="flex:1;">
                 <div style="display:flex; gap:10px;">
                   <div style="flex:1;"><label>Company Name</label><div id="pf-company" style="padding:15px;background:#fff;border-radius:6px;border:1px solid #eee;">-</div></div>
                   <div style="flex:1;"><label>OIC Name</label><div id="pf-oic" style="padding:15px;background:#fff;border-radius:6px;border:1px solid #eee;">-</div></div>
                   <div style="flex:1;"><label>OIC Contact</label><div id="pf-contact" style="padding:15px;background:#fff;border-radius:6px;border:1px solid #eee;">-</div></div>
                 </div>
                 <div style="display:flex; gap:10px; margin-top:8px;">
                   <div style="flex:1;"><label>Company Email</label><div id="pf-email" style="padding:15px;background:#fff;border-radius:6px;border:1px solid #eee;">-</div></div>
                 </div>
                 <div style="display:flex; gap:10px; margin-top:8px;">
                   <div style="flex:1;"><label>HQ Address</label><div id="pf-addr" style="padding:15px;background:#fff;border-radius:6px;border:1px solid #eee;">-</div></div>
                 </div>
               </div>

               <!-- hidden file input -->
               <input type="file" id="profile-avatar-file" accept="image/*" style="display:none;" onchange="handleAvatarFile(this)">
             </div>

             <div style="margin-top:20px;">
               <h3>History</h3>
               <div style="display:flex; gap:10px; margin-bottom:10px;">
                 <button id="hist-orders-btn" class="filter-btn" onclick="loadProfileHistoryOrders()">Orders</button>
                 <button id="hist-items-btn" class="filter-btn" onclick="loadProfileHistoryItems()">My Items</button>
               </div>
               <div id="profile-history" style="background:#fff;padding:12px;border-radius:8px;border:1px solid #eee;">
                 <p class="muted">Loading history...</p>
               </div>
             </div>
           </div>
       </div>

       <div id="admin-section" class="main-content page-section">
           <h2>Admin Console</h2>
           <div id="admin-threads"></div>
           <div style="margin-top:12px;">
             <h3>All Messages</h3>
             <div id="admin-messages" style="background:#fff;padding:12px;border-radius:8px;border:1px solid #eee;"></div>
           </div>
       </div>

       <div id="add-modal" class="modal-overlay" style="display:none;">
          <div class="modal-box">
             <span class="material-icons" style="position:absolute; top:20px; right:20px; cursor:pointer; color:#999;" onclick="closeAddModal()">close</span>
             <h2 class="modal-title">Add New Uniform</h2>
             <form id="add-form" onsubmit="event.preventDefault(); submitItem();">
                <div class="section-title">Uniform Information</div>
                <div class="form-row">
                    <div class="form-col">
                        <label>Category <span style="color:#d93025">*</span></label>
                        <select id="in-cat" onchange="renderPhotoSlots()" required>
                            <option value="" disabled selected>Select Category...</option>
                            <option value="Shirt">Shirt</option>
                            <option value="Pants">Pants</option>
                        </select>
                    </div>
                    <div class="form-col">
                        <label>Size <span style="color:#d93025">*</span></label>
                        <select id="in-size" required>
                            <option value="" disabled selected>Select Size...</option>
                            <option value="XS">XS</option>
                            <option value="S">S</option>
                            <option value="M">M</option>
                            <option value="L">L</option>
                            <option value="XL">XL</option>
                            <option value="2XL">2XL</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                     <div class="form-col">
                        <label>Type</label>
                        <div class="radio-group">
                            <label class="radio-item">
                                <input type="radio" name="type" value="Donate" onclick="togglePrice(false)" checked> 
                                <span>Donate</span>
                            </label>
                            <label class="radio-item">
                                <input type="radio" name="type" value="Sell" onclick="togglePrice(true)"> 
                                <span>Sell</span>
                            </label>
                        </div>
                     </div>
                     <div class="form-col" id="price-div" style="display:none;">
                        <label>Price (RM) <span style="color:#d93025">*</span></label>
                        <input type="number" id="in-price" placeholder="e.g. 50">
                     </div>
                </div>

                <div class="form-col" style="margin-bottom:20px;">
                    <label>Photos <span style="color:#d93025">*</span></label>
                    <div id="photo-container">
                        <p style="color:#999; font-size:14px; margin:auto;">Please select a Category to view required photos.</p>
                    </div>
                </div>

                <div class="section-title">Personal Information</div>
                <div class="form-row">
                    <div class="form-col">
                        <label>Company Name <span style="color:#d93025">*</span></label>
                        <input type="text" id="in-comp" required placeholder="e.g. 1st Penang Company">
                    </div>
                    <div class="form-col">
                        <label>HQ Address <span style="color:#d93025">*</span></label>
                        <input type="text" id="in-addr" required placeholder="Full Address">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label>Company Email <span style="color:#d93025">*</span></label>
                        <input type="email" id="in-email" required placeholder="Email">
                    </div>
                    <div class="form-col">
                        <label>Donor/Seller Name <span style="color:#d93025">*</span></label>
                        <input type="text" id="in-name" required placeholder="Your Name">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-col">
                        <label>OIC Name <span style="color:#d93025">*</span></label>
                        <input type="text" id="in-oic" required placeholder="Officer In Charge Name">
                    </div>
                    <div class="form-col">
                        <label>OIC Contact <span style="color:#d93025">*</span></label>
                        <input type="tel" id="in-contact" required placeholder="e.g. 012-3456789">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeAddModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Submit</button>
                </div>
            </form>
          </div>
       </div>

       <!-- Detail Modal -->
       <div id="detail-modal" class="modal-overlay" style="display:none;">
         <div class="modal-box" id="detail-box">
           <span class="material-icons" style="position:absolute; top:20px; right:20px; cursor:pointer; color:#999;" onclick="closeDetailModal()">close</span>
           <div id="detail-content"></div>
         </div>
       </div>

       <!-- Buy Modal -->
       <div id="buy-modal" class="modal-overlay" style="display:none;">
         <div class="modal-box">
           <span class="material-icons" style="position:absolute; top:20px; right:20px; cursor:pointer; color:#999;" onclick="closeBuyModal()">close</span>
           <h3>Buyer Information</h3>
           <div id="buy-error" class="error-msg"></div>
           <div style="display:flex; gap:10px; margin-top:10px;">
             <div style="flex:1;"><label>Company Name</label><input id="buy-company" type="text"></div>
             <div style="flex:1;"><label>HQ Address</label><input id="buy-addr" type="text"></div>
           </div>
           <div style="display:flex; gap:10px; margin-top:10px;">
             <div style="flex:1;"><label>Company Email</label><input id="buy-email" type="email"></div>
             <div style="flex:1;"><label>OIC Name</label><input id="buy-oic" type="text"></div>
           </div>
           <div style="margin-top:10px;">
             <label>OIC Contact</label>
             <input id="buy-contact" type="text">
           </div>
           <div style="margin-top:12px; text-align:right;">
             <button class="btn-cancel" onclick="closeBuyModal()">Cancel</button>
             <button class="btn-submit" onclick="submitBuy()">Submit</button>
           </div>
         </div>
       </div>

       <!-- Help Chat Modal -->
       <div id="help-modal" class="modal-overlay" style="display:none;">
         <div class="modal-box" style="max-width:520px;">
           <span class="material-icons" style="position:absolute; top:20px; right:20px; cursor:pointer; color:#999;" onclick="closeHelpChat()">close</span>
           <h3>Help / Chat</h3>
           <div id="chat-window" style="height:300px; overflow-y:auto; background:#fafafa; padding:8px; border-radius:6px; border:1px solid #eee;"></div>
           <div style="display:flex; gap:8px; margin-top:8px;">
             <input id="chat-input" type="text" placeholder="Type message..." style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;">
             <button class="btn-submit" onclick="sendChatMessage()">Send</button>
           </div>
         </div>
       </div>
    </div> 
    
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="color: #555; font-weight: 500;">Processing...</div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal-overlay" style="display:none;">
      <div class="modal-box" style="max-width:560px;">
        <span class="material-icons" style="position:absolute; top:20px; right:20px; cursor:pointer; color:#999;" onclick="closeEditProfileModal()">close</span>
        <h3>Edit Profile Information</h3>
        <div id="edit-pf-error" class="error-msg"></div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <div style="flex:1;"><label>Company Name</label><input id="edit-pf-company" type="text"></div>
          <div style="flex:1;"><label>HQ Address</label><input id="edit-pf-addr" type="text"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
          <div style="flex:1;"><label>Company Email</label><input id="edit-pf-email" type="email"></div>
          <div style="flex:1;"><label>OIC Name</label><input id="edit-pf-oic" type="text"></div>
        </div>
        <div style="margin-top:10px;">
          <label>OIC Contact</label>
          <input id="edit-pf-contact" type="text">
        </div>
        <div style="margin-top:14px; text-align:right;">
          <button class="btn-cancel" onclick="closeEditProfileModal()">Cancel</button>
          <button class="btn-submit" onclick="confirmSaveProfileFromModal()">Save</button>
        </div>
      </div>
    </div>

    <!-- Verify Current Password Modal (replaces native prompt) -->
    <div id="verify-current-modal" class="modal-overlay" style="display:none;">
      <div class="modal-box" style="max-width:420px;">
        <span class="material-icons" style="position:absolute; top:18px; right:18px; cursor:pointer; color:#999;" onclick="closeVerifyModal()">close</span>
        <h3>Verify Current Password</h3>
        <p style="font-size:13px;color:#666;">Enter your current password to continue.</p>
        <div id="verify-error" class="error-msg"></div>
        <div class="input-group" style="margin-top:10px;">
          <label>Current Password</label>
          <div class="input-wrapper">
            <input type="password" id="verify-current-input" placeholder="Enter current password">
            <span class="material-icons toggle-password" onclick="toggleVisibility('verify-current-input', this)">visibility_off</span>
          </div>
        </div>
        <div style="margin-top:12px; text-align:right;">
          <button class="btn-cancel" onclick="closeVerifyModal()">Cancel</button>
          <button class="btn-submit" onclick="submitVerifyCurrent()">Verify</button>
        </div>
      </div>
    </div>

    <!-- Change Password Modal (for logged-in user) -->
    <div id="change-password-modal" class="modal-overlay" style="display:none;">
      <div class="modal-box" style="max-width:520px;">
        <span class="material-icons" style="position:absolute; top:20px; right:20px; cursor:pointer; color:#999;" onclick="closeChangePasswordModal()">close</span>
        <h3>Change Password</h3>
        <div id="change-pw-error" class="error-msg"></div>
        <!-- current password input kept but may be hidden when pre-verified -->
        <div class="input-group" style="margin-top:10px;">
          <label>Current Password</label>
          <div class="input-wrapper">
            <input type="password" id="cur-password">
            <span class="material-icons toggle-password" onclick="toggleVisibility('cur-password', this)">visibility_off</span>
          </div>
        </div>
        <div class="input-group">
          <label>New Password</label>
          <div class="input-wrapper">
            <input type="password" id="cur-new-password">
            <span class="material-icons toggle-password" onclick="toggleVisibility('cur-new-password', this)">visibility_off</span>
          </div>
        </div>
        <div class="input-group">
          <label>Confirm New Password</label>
          <div class="input-wrapper">
            <input type="password" id="cur-confirm-password">
            <span class="material-icons toggle-password" onclick="toggleVisibility('cur-confirm-password', this)">visibility_off</span>
          </div>
        </div>
        <div style="margin-top:12px; text-align:right;">
          <button class="btn-cancel" onclick="closeChangePasswordModal()">Cancel</button>
          <button class="btn-submit" onclick="changePasswordWithCurrent()">Change Password</button>
        </div>
      </div>
    </div>

    <script>
      var tempUsername = "";
      var tempRole = "";
      var currentUser = "";
      var userRole = "";
      var currentDetailItem = null;
      var currentOrderIdFromEmail = null;
      var avatarBase64ToUpload = null;
      var lastLoadedProfile = null; // cache last profile to decide when to sync to forms

      // client-side flag: whether current password was pre-verified (used when we pre-verify before opening modal)
      window._currentPasswordVerified = false;
      window._currentPasswordValue = "";

      // --- Feature: Password Visibility Toggle ---
      function toggleVisibility(inputId, iconElement) {
        var input = document.getElementById(inputId);
        if (input.type === "password") {
          input.type = "text";
          iconElement.textContent = "visibility"; 
        } else {
          input.type = "password";
          iconElement.textContent = "visibility_off"; 
        }
      }

      // --- Loading Control ---
      function showLoading(show) {
        document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
      }

      // --- Login Handler ---
      function handleLogin() {
        var user = document.getElementById('username').value.trim();
        var pass = document.getElementById('password').value;
        var errorDiv = document.getElementById('login-error');
        
        errorDiv.style.display = 'none';

        if(!user || !pass) {
          errorDiv.textContent = "Please enter username and password";
          errorDiv.style.display = 'block';
          return;
        }

        showLoading(true); 

        google.script.run
          .withSuccessHandler(function(response) {
            showLoading(false); 

            if (response.success) {
              tempUsername = response.username;
              tempRole = response.role || 'user';
              
              if (response.isFirstLogin) {
                document.getElementById('modal-overlay').style.display = 'flex';
              } else {
                sessionStorage.setItem('isLoggedIn', 'true');
                sessionStorage.setItem('currentUser', response.username);
                sessionStorage.setItem('role', response.role);
                
                loginSuccess(response.username, response.role);
              }
            } else {
              errorDiv.textContent = response.message;
              errorDiv.style.display = 'block';
            }
          })
          .attemptLogin(user, pass);
      }

      // make Enter key on login inputs trigger login
      function _attachEnterLogin() {
        var card = document.getElementById('login-card');
        if (!card) return;
        card.addEventListener('keydown', function(e){
          if (e.key === 'Enter') {
            e.preventDefault();
            handleLogin();
          }
        });
      }

      // --- Change Password Handler (first-login handler) ---
      // Modified: after first-login change, do NOT force logout — instead log user in automatically.
      function handleChangePassword() {
        var newPass = document.getElementById('new-password').value;
        var confirmPass = document.getElementById('confirm-password').value;
        var errorDiv = document.getElementById('modal-error');
        
        errorDiv.style.display = 'none';

        if (newPass.length < 7) {
          errorDiv.textContent = "Password must be at least 7 characters";
          errorDiv.style.display = 'block';
          return;
        }
        
        if (!/\d/.test(newPass)) {
          errorDiv.textContent = "Password must contain at least one number";
          errorDiv.style.display = 'block';
          return;
        }

        if (newPass !== confirmPass) {
          errorDiv.textContent = "Passwords do not match";
          errorDiv.style.display = 'block';
          return;
        }

        showLoading(true);

        google.script.run
          .withSuccessHandler(function(response) {
            showLoading(false);
            if (response.success) {
              // Do not force logout. Auto-login the user (this was the account used to sign in before first-login flow)
              sessionStorage.setItem('isLoggedIn', 'true');
              sessionStorage.setItem('currentUser', tempUsername);
              sessionStorage.setItem('role', tempRole || 'user');
              alert("Password changed successfully!");
              document.getElementById('modal-overlay').style.display = 'none';
              document.getElementById('new-password').value = "";
              document.getElementById('confirm-password').value = "";
              // call client login success to proceed to dashboard
              loginSuccess(tempUsername, tempRole || 'user');
            } else {
              errorDiv.textContent = response.message || "Update failed, please try again.";
              errorDiv.style.display = 'block';
            }
          })
          .withFailureHandler(function(err) {
            showLoading(false);
            console.error('changeUserPassword failed:', err);
            var msg = (err && err.message) ? err.message : JSON.stringify(err);
            errorDiv.textContent = "Update failed: " + msg;
            errorDiv.style.display = 'block';
          })
          .changeUserPassword(tempUsername, newPass);
      }

      // ================= 5. Login Success Logic =================
      function loginSuccess(username, role) {
        currentUser = username;
        userRole = role;
        
        // Show Admin nav if admin
        if (role === 'admin') document.getElementById('nav-admin').style.display = 'inline-block';
        else document.getElementById('nav-admin').style.display = 'none';

        // Hide Login, Show Dashboard
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('dashboard-view').style.display = 'block';
        
        // Restore last tab if any (persist across refresh)
        var lastTab = sessionStorage.getItem('currentTab') || 'home';
        switchTab(lastTab);

        // Load profile into profile page (no full-screen overlay here)
        loadUserProfile(false);
      }

      // ================= 6. Tab Switching =================
      function switchTab(tabName) {
         document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
         document.querySelectorAll('.nav-menu a').forEach(el => el.classList.remove('active'));
         
         document.getElementById(tabName + '-section').classList.add('active');
         var nav = document.getElementById('nav-' + tabName);
         if (nav) nav.classList.add('active');

         // persist current tab so refresh stays on same page
         sessionStorage.setItem('currentTab', tabName);
         
         if(tabName === 'home') loadInventory();
         if(tabName === 'profile') loadUserProfile(false); // avoid full-screen loading when simply viewing
         if(tabName === 'about') { /* static content - nothing to load */ }
         if(tabName === 'admin') loadAdminConsole();
      }

      // ================= 7. Inventory Logic (with search & filter) =================
      function toggleFilterPanel(){
        var p = document.getElementById('filter-panel');
        p.style.display = (p.style.display === 'none' || p.style.display === '') ? 'block' : 'none';
      }
      function resetFilters(){
        document.getElementById('filter-category').value = "";
        document.getElementById('filter-size').value = "";
        document.getElementById('filter-type').value = "";
        document.getElementById('search-text').value = "";
        loadInventory();
      }
      function applyFilters() {
        loadInventory();
        // auto close filter panel for simpler UX
        document.getElementById('filter-panel').style.display = 'none';
      }

      // toggle price field visibility in Add form
      function togglePrice(show) {
        var el = document.getElementById('price-div');
        if (show) el.style.display = 'block';
        else el.style.display = 'none';
      }

      // 全域快取，避免把物件序列化放到 HTML 屬性
var itemsCache = [];

// 輔助：HTML escape（避免 innerHTML 被破壞）
function _escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

// Parse images field (may be JSON-string, object, or plain URL) => return array of URLs
function _getImageUrls(imagesField) {
  if (!imagesField && imagesField !== "") return [];
  // If it's already an array (rare)
  if (Array.isArray(imagesField)) {
    return imagesField.map(_normalizeDriveUrl).filter(Boolean);
  }
  // If it's object with keys
  if (typeof imagesField === 'object') {
    var out = [];
    Object.keys(imagesField).forEach(function(k){
      var v = imagesField[k];
      if (v) out.push(_normalizeDriveUrl(String(v)));
    });
    return out;
  }
  // String: maybe JSON, maybe a single URL
  if (typeof imagesField === 'string') {
    var s = imagesField.trim();
    if (!s) return [];
    // try parse JSON
    try {
      var parsed = JSON.parse(s);
      return _getImageUrls(parsed);
    } catch(e) {
      // treat as single URL
      return [_normalizeDriveUrl(s)];
    }
  }
  return [];
}

// Normalize Google Drive links into direct view URL if possible
function _normalizeDriveUrl(url) {
  if (!url) return "";
  try {
    var u = String(url).trim();
    // already uc view?
    if (u.indexOf('uc?export=view') > -1 || u.indexOf('lh3.googleusercontent') > -1) return u;
    // pattern /d/FILEID/
    var m = u.match(/\/d\/([a-zA-Z0-9_-]{10,})/);
    if (m && m[1]) return 'https://drive.google.com/uc?export=view&id=' + m[1];
    // id=FILEID
    m = u.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
    if (m && m[1]) return 'https://drive.google.com/uc?export=view&id=' + m[1];
    // fallback: return original
    return u;
  } catch(e) {
    return url;
  }
}

/* ---------- Fullscreen viewer (unchanged) ---------- */
(function(){
  // create overlay once
  var overlay = document.createElement('div');
  overlay.id = 'fullscreen-image-overlay';
  overlay.innerHTML = `
    <button class="fs-close" aria-label="Close (Esc)">✕</button>
    <button class="fs-prev" aria-label="Previous">◀</button>
    <img class="fs-img" src="" alt="Photo">
    <button class="fs-next" aria-label="Next">▶</button>
    <div class="fs-hint">← swipe / ← → keys to navigate • Esc to close</div>
  `;
  document.body.appendChild(overlay);
  var imgEl = overlay.querySelector('.fs-img');
  var btnClose = overlay.querySelector('.fs-close');
  var btnPrev = overlay.querySelector('.fs-prev');
  var btnNext = overlay.querySelector('.fs-next');

  var urls = [], currentIndex = 0;

  function showOverlay(index) {
    if (!urls || urls.length === 0) return;
    currentIndex = Math.max(0, Math.min(index || 0, urls.length - 1));
    imgEl.src = urls[currentIndex];
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    updateButtons();
  }
  function hideOverlay() {
    overlay.style.display = 'none';
    document.body.style.overflow = '';
    imgEl.src = '';
  }
  function updateButtons(){
    btnPrev.style.display = (urls.length > 1) ? 'block' : 'none';
    btnNext.style.display = (urls.length > 1) ? 'block' : 'none';
  }
  function showNext() {
    if (!urls.length) return;
    currentIndex = (currentIndex + 1) % urls.length;
    imgEl.src = urls[currentIndex];
  }
  function showPrev() {
    if (!urls.length) return;
    currentIndex = (currentIndex - 1 + urls.length) % urls.length;
    imgEl.src = urls[currentIndex];
  }

  // touch swipe support
  var touchStartX = 0, touchEndX = 0;
  imgEl.addEventListener('touchstart', function(e){ touchStartX = e.changedTouches[0].screenX; }, {passive:true});
  imgEl.addEventListener('touchend', function(e){ touchEndX = e.changedTouches[0].screenX; if (touchEndX - touchStartX > 50) showPrev(); else if (touchStartX - touchEndX > 50) showNext(); }, {passive:true});

  btnClose.addEventListener('click', hideOverlay);
  btnNext.addEventListener('click', showNext);
  btnPrev.addEventListener('click', showPrev);

  // keyboard navigation / esc
  function _onKey(e) {
    if (overlay.style.display !== 'flex') return;
    if (e.key === 'ArrowRight') showNext();
    if (e.key === 'ArrowLeft') showPrev();
    if (e.key === 'Escape') hideOverlay();
  }
  document.addEventListener('keydown', _onKey);

  // exposed global helper
  window.openFullscreenViewer = function(imageUrls, startIndex) {
    urls = (imageUrls && imageUrls.length) ? imageUrls : [];
    startIndex = startIndex || 0;
    showOverlay(startIndex);
  };
  window.closeFullscreenViewer = hideOverlay;
})();

/* ---------- loadInventory (HOME) ---------- */
function loadInventory() {
    var grid = document.getElementById('inventory-grid');
    if (!grid) return;

    grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#666;">Loading items...</div>';

    var searchText = document.getElementById('search-text').value || "";
    var filters = {
      category: document.getElementById('filter-category').value || "",
      size: document.getElementById('filter-size').value || "",
      type: document.getElementById('filter-type').value || ""
    };

    google.script.run
       .withSuccessHandler(function(items){
           itemsCache = items || []; // cache for later lookup
           grid.innerHTML = "";

           if(!itemsCache || itemsCache.length === 0) {
               grid.innerHTML = "<div style='grid-column:1/-1; text-align:center; color:#999; padding:20px;'>No items found.</div>";
               return;
           }

           itemsCache.forEach(function(item){
               var imgUrl = _getImageUrls(item.images)[0] || "";

               var priceDisplay = (item.type === 'Donate') ? 'Donate' : ('RM ' + (item.price || '0'));
               var sizeDisplay = item.size ? (item.size + " Size") : "";
               var timeSource = item.date || item.timestamp || "";
               var timeDisplay = getTimeAgo(timeSource);

               // 建立卡片 DOM
               var card = document.createElement('div');
               card.className = 'item-card';
               card.dataset.code = item.code || '';

               var photoBox = document.createElement('div');
               photoBox.className = 'card-photo-box';

               if (imgUrl) {
                   var imgEl = document.createElement('img');
                   imgEl.src = imgUrl;
                   imgEl.loading = 'lazy';
                   photoBox.appendChild(imgEl);
                   // IMPORTANT: do NOT open fullscreen from HOME; clicking card goes to detail
               } else {
                   var noPhoto = document.createElement('div');
                   noPhoto.style = 'display:flex;align-items:center;justify-content:center;height:100%;color:#ccc;';
                   noPhoto.innerText = 'No Photo';
                   photoBox.appendChild(noPhoto);
               }

               var codeBadge = document.createElement('div');
               codeBadge.className = 'card-code';
               codeBadge.innerText = item.code || '';
               photoBox.appendChild(codeBadge);

               var details = document.createElement('div');
               details.className = 'card-details';

               // company name inline (use newly added Company column)
               var companyName = item.company || item.companyName || item.sellerName || item.seller || item.sellerEmail || "";

               // build footer with time (left) and company (right)
               var footer = document.createElement('div');
               footer.className = 'card-footer';
               var timeDiv = document.createElement('div');
               timeDiv.className = 'card-time';
               timeDiv.innerHTML = '<img src="https://png.pngtree.com/png-clipart/20250104/original/pngtree-black-time-icon-png-image_5464066.png" class="time-icon" alt="time">' + _escapeHtml(timeDisplay || 'N/A');
               var compDiv = document.createElement('div');
               compDiv.className = 'card-company-inline';
               compDiv.innerText = companyName;

               footer.appendChild(timeDiv);
               footer.appendChild(compDiv);

               details.innerHTML = '<div class="card-title">' + _escapeHtml(item.category || '') + '</div>' +
                                   '<div class="card-size">' + _escapeHtml(sizeDisplay) + '</div>' +
                                   '<div class="card-price">' + _escapeHtml(priceDisplay) + '</div>';
               details.appendChild(footer);

               card.appendChild(photoBox);
               card.appendChild(details);

               // 點擊卡片進入 detail
               card.addEventListener('click', function () {
                   console.log('Item clicked:', item);
                   openDetailModal(item);
               });

               grid.appendChild(card);
           });
       })
       .withFailureHandler(function(err){
           grid.innerHTML = "<div style='grid-column:1/-1; text-align:center; color:#d32f2f; padding:20px;'>Error loading items.</div>";
           console.error('searchInventory failed', err);
       })
       .searchInventory(searchText, filters);
}

/* ---------- openDetailModal (uses item.company) ---------- */
function openDetailModal(item) {
  currentDetailItem = item;
  var content = document.getElementById('detail-content');
  content.innerHTML = ''; // clear previous

  var urls = _getImageUrls(item.images || item.img || item.photos);

  // container
  var grid = document.createElement('div');
  grid.className = 'detail-grid';

  // LEFT: photo area
  var left = document.createElement('div');
  left.className = 'detail-photo';

  var frame = document.createElement('div');
  frame.className = 'photo-frame';

  var mainImg = document.createElement('img');
  mainImg.className = 'main-photo';
  mainImg.alt = item.code || '';
  if (urls.length > 0) mainImg.src = urls[0];
  else {
    mainImg.src = '';
  }
  frame.appendChild(mainImg);
  left.appendChild(frame);

  // Add left/right arrow buttons inside frame (placed absolutely)
var prevBtn = document.createElement('button');
prevBtn.className = 'detail-prev';
prevBtn.type = 'button';
prevBtn.innerHTML = '◀';

var nextBtn = document.createElement('button');
nextBtn.className = 'detail-next';
nextBtn.type = 'button';
nextBtn.innerHTML = '▶';

if (urls.length <= 1) {
  prevBtn.style.display = 'none';
  nextBtn.style.display = 'none';
}

frame.appendChild(prevBtn);
frame.appendChild(nextBtn);
left.appendChild(frame);

  // dots
  var dots = document.createElement('div');
  dots.className = 'carousel-dots';
  if (urls.length > 0) {
    urls.forEach(function(u, idx){
      var d = document.createElement('div');
      d.className = 'carousel-dot' + (idx === 0 ? ' active' : '');
      d.dataset.index = idx;
      d.title = 'View photo ' + (idx + 1);
      d.addEventListener('click', function(){
        var i = parseInt(this.dataset.index, 10);
        mainImg.src = urls[i];
        // update active
        dots.querySelectorAll('.carousel-dot').forEach(function(el,i2){ el.classList.toggle('active', i2===i); });
      });
      dots.appendChild(d);
    });
  }
  left.appendChild(dots);
  
  // Arrow handlers
  var currentIndex = 0;
  function showIndex(i) {
    if (!urls || urls.length === 0) return;
    currentIndex = (i + urls.length) % urls.length;
    mainImg.src = urls[currentIndex];
    dots.querySelectorAll('.carousel-dot').forEach(function(el,i2){ el.classList.toggle('active', i2===currentIndex); });
  }
  prevBtn.addEventListener('click', function(e){ e.stopPropagation(); showIndex(currentIndex - 1); });
  nextBtn.addEventListener('click', function(e){ e.stopPropagation(); showIndex(currentIndex + 1); });

  // clicking mainImg opens fullscreen viewer
  mainImg.addEventListener('click', function(e){
    e.stopPropagation();
    if (urls && urls.length) openFullscreenViewer(urls, currentIndex);
  });

  // RIGHT: info area (use company)
  var right = document.createElement('div');
  right.className = 'detail-info';

  var title = document.createElement('div');
  title.className = 'title';
  title.innerHTML = (item.category ? _escapeHtml(item.category) : 'Item') + ' &nbsp;–&nbsp; ' + _escapeHtml(item.code || '');
  right.appendChild(title);

  var price = document.createElement('div');
  price.className = 'price';
  price.innerText = (item.type === 'Donate' ? 'Donate' : ('RM ' + (item.price || '0')));
  right.appendChild(price);

  var meta = document.createElement('div');
  meta.className = 'meta';
  meta.innerHTML = '<div><strong>Size:</strong> ' + _escapeHtml(item.size || 'N/A') + '</div>'
                 + '<div style="margin-top:6px;"><strong>Company:</strong> ' + _escapeHtml(item.company || item.sellerName || '') + '</div>';
  right.appendChild(meta);

  var when = document.createElement('div');
  when.className = 'muted';
  var timeText = '';
  if (item.DateCreates || item.DateCreate || item.date || item.timestamp) {
    var exact = item.DateCreates || item.DateCreate || item.date || item.timestamp;
    timeText = formatDateDDMMYY(exact);
  }
  when.innerHTML = '<img src="https://png.pngtree.com/png-clipart/20250104/original/pngtree-black-time-icon-png-image_5464066.png" style="width:16px;height:16px;opacity:0.9;margin-right:6px;">' + (timeText || '');
  right.appendChild(when);

  var actions = document.createElement('div');
  actions.className = 'actions';
  var btnCancel = document.createElement('button');
  btnCancel.className = 'btn-cancel';
  btnCancel.innerText = 'CANCEL';
  btnCancel.addEventListener('click', closeDetailModal);
  var btnBuy = document.createElement('button');
  btnBuy.className = 'btn-buy';
  btnBuy.innerText = 'BUY';
  btnBuy.addEventListener('click', function(){
    openBuyModal();
  });
  actions.appendChild(btnCancel); actions.appendChild(btnBuy);
  right.appendChild(actions);

  grid.appendChild(left); grid.appendChild(right);
  content.appendChild(grid);
  document.getElementById('detail-modal').style.display = 'flex';
}

      // Helper: Time Ago (for card)
      function getTimeAgo(dateString) {
          if (!dateString) return "";
          var date = new Date(dateString);
          var now = new Date();
          var seconds = Math.floor((now - date) / 1000);
          if (isNaN(seconds)) return "";
          
          var interval = Math.floor(seconds / 31536000);
          if (interval >= 1) return interval + (interval === 1 ? " year ago" : " years ago");
          interval = Math.floor(seconds / 2592000);
          if (interval >= 1) return interval + (interval === 1 ? " month ago" : " months ago");
          interval = Math.floor(seconds / 86400);
          if (interval >= 1) return interval + (interval === 1 ? " day ago" : " days ago");
          interval = Math.floor(seconds / 3600);
          if (interval >= 1) return interval + (interval === 1 ? " hour ago" : " hours ago");
          interval = Math.floor(seconds / 60);
          if (interval >= 1) return interval + (interval === 1 ? " minute ago" : " minutes ago");
          return "Just now";
      }

      // format dd/mm/yy
      function formatDateDDMMYY(dateInput) {
        if (!dateInput && dateInput !== 0) return "";
        var d = new Date(dateInput);
        if (isNaN(d.getTime())) {
          var s = String(dateInput).trim();
          var parts = s.split(/[T\s]+/)[0].split(/[\/\-\.]+/);
          if (parts.length >= 3) {
            var y = parts[0], m = parts[1], day = parts[2];
            if (y.length === 4) { d = new Date(y, (m||1)-1, day); }
            else { d = new Date(parts[2], (parts[1]||1)-1, parts[0]); }
          }
        }
        if (isNaN(d.getTime())) return String(dateInput);
        var day = ("0" + d.getDate()).slice(-2);
        var month = ("0" + (d.getMonth()+1)).slice(-2);
        var year = String(d.getFullYear()).slice(-2);
        return day + "/" + month + "/" + year;
      }

      function closeDetailModal(){ document.getElementById('detail-modal').style.display='none'; }

      function openBuyModal(){
        // Pre-fill buyer profile if logged in
        if (!currentUser) {
          alert("Please login to proceed with buying.");
          return;
        }
        showLoading(true);
        google.script.run.withSuccessHandler(function(profile){
          showLoading(false);
          if (profile) {
            document.getElementById('buy-company').value = profile.companyName || "";
            document.getElementById('buy-addr').value = profile.hqAddress || "";
            document.getElementById('buy-email').value = profile.email || "";
            document.getElementById('buy-oic').value = profile.oicName || "";
            document.getElementById('buy-contact').value = profile.oicContact || "";
          }
          document.getElementById('buy-modal').style.display = 'flex';
        }).getUserProfile(currentUser);
      }
      function closeBuyModal(){ document.getElementById('buy-modal').style.display='none'; }

      function submitBuy(){
        var errorDiv = document.getElementById('buy-error');
        errorDiv.style.display = 'none';
        var buyer = {
          companyName: document.getElementById('buy-company').value.trim(),
          hqAddress: document.getElementById('buy-addr').value.trim(),
          email: document.getElementById('buy-email').value.trim(),
          oicName: document.getElementById('buy-oic').value.trim(),
          oicContact: document.getElementById('buy-contact').value.trim()
        };
        if (!buyer.companyName || !buyer.email) {
          errorDiv.textContent = "Please fill required fields (Company name and Email)";
          errorDiv.style.display = 'block';
          return;
        }
        if (!confirm("Confirm submit buy request?")) return;
        showLoading(true);
        google.script.run
          .withSuccessHandler(function(res){
            showLoading(false);
            if (res.success) {
              alert("Your interest has been submitted. Seller will be notified via email.");
              closeBuyModal();
              closeDetailModal();
            } else {
              alert("Error: " + res.message);
            }
          })
          .submitBuyRequest(currentDetailItem.code, buyer);
      }

      // ================= Profile page logic =================
      function loadUserProfile(useLoading) {
        // default useLoading true unless explicitly false
        var showOverlay = (useLoading === undefined) ? true : !!useLoading;
        if (showOverlay) showLoading(true);
        if (!currentUser) {
          if (showOverlay) showLoading(false);
          return;
        }
        google.script.run.withSuccessHandler(function(profile){
          if (showOverlay) showLoading(false);
          if (!profile) return;
          // cache previously loaded profile for sync logic
          lastLoadedProfile = profile;
          document.getElementById('pf-company').innerText = profile.companyName || "";
          document.getElementById('pf-addr').innerText = profile.hqAddress || "";
          document.getElementById('pf-email').innerText = profile.email || "";
          document.getElementById('pf-oic').innerText = profile.oicName || "";
          document.getElementById('pf-contact').innerText = profile.oicContact || "";
          if (profile.avatarUrl) document.getElementById('profile-avatar').src = profile.avatarUrl;
          // load history default to Orders (no full screen)
          loadProfileHistoryOrders();

          // sync profile to open forms if appropriate (Add / Buy)
          syncProfileToForms(profile);
        }).getUserProfile(currentUser);
      }

      // sync profile values into add/buy forms when appropriate
      function syncProfileToForms(profile) {
        if (!profile) return;
        // mapping: element id -> profile key to use
        var mappings = [
          { el: 'in-comp', key: 'companyName' },
          { el: 'in-addr', key: 'hqAddress' },
          { el: 'in-email', key: 'email' },
          { el: 'in-name', key: 'oicName' }, // donor/seller name -> OIC name if available
          { el: 'in-oic', key: 'oicName' },
          { el: 'in-contact', key: 'oicContact' },

          { el: 'buy-company', key: 'companyName' },
          { el: 'buy-addr', key: 'hqAddress' },
          { el: 'buy-email', key: 'email' },
          { el: 'buy-oic', key: 'oicName' },
          { el: 'buy-contact', key: 'oicContact' }
        ];

        mappings.forEach(function(m){
          var el = document.getElementById(m.el);
          if (!el) return;
          var cur = (el.value || '').toString().trim();
          var prev = (lastLoadedProfile && lastLoadedProfile[m.key]) ? (lastLoadedProfile[m.key] || '') : '';
          var newVal = profile[m.key] || '';
          // If current is empty OR equals previous profile value, replace with new profile value.
          if (!cur || (prev && cur === prev)) {
            el.value = newVal;
          }
        });
      }

      function saveProfile(){
        var payload = {
          companyName: document.getElementById('pf-company').innerText || document.getElementById('pf-company').value,
          hqAddress: document.getElementById('pf-addr').innerText || document.getElementById('pf-addr').value,
          email: document.getElementById('pf-email').innerText || document.getElementById('pf-email').value,
          oicName: document.getElementById('pf-oic').innerText || document.getElementById('pf-oic').value,
          oicContact: document.getElementById('pf-contact').innerText || document.getElementById('pf-contact').value
        };
        if (avatarBase64ToUpload) payload.avatarBase64 = avatarBase64ToUpload;
        showLoading(true);
        google.script.run.withSuccessHandler(function(res){
          showLoading(false);
          if (res.success) {
            alert("Profile updated");
            avatarBase64ToUpload = null;
            loadUserProfile();
          } else {
            alert("Error: " + res.message);
          }
        }).updateUserProfile(currentUser, payload);
      }

      // Profile menu & hidden file input handlers
      function toggleProfileMenu(){
        var m = document.getElementById('profile-menu');
        if (!m) return;
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
      }
      function triggerChangeProfilePicture(){
        document.getElementById('profile-avatar-file').click();
      }

      function handleAvatarFile(input){
        if (input.files && input.files[0]){
          var reader = new FileReader();
          reader.onload = function(e){
            avatarBase64ToUpload = e.target.result;
            document.getElementById('profile-avatar').src = e.target.result;
            if (!confirm('Upload this profile picture?')) { avatarBase64ToUpload = null; loadUserProfile(false); return; }
            showLoading(true);
            // IMPORTANT: call updateUserProfile with only avatarBase64 so server won't wipe other fields
            google.script.run.withSuccessHandler(function(res){
              showLoading(false);
              if (res.success) { alert('Profile picture updated'); loadUserProfile(false); }
              else alert('Error: ' + (res.message || 'Upload failed'));
            }).updateUserProfile(currentUser, { avatarBase64: avatarBase64ToUpload });
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      // Edit profile modal (opened from hamburger)
      function openEditProfileModal(){
        // populate modal fields
        document.getElementById('edit-pf-company').value = document.getElementById('pf-company').innerText || '';
        document.getElementById('edit-pf-addr').value = document.getElementById('pf-addr').innerText || '';
        document.getElementById('edit-pf-email').value = document.getElementById('pf-email').innerText || '';
        document.getElementById('edit-pf-oic').value = document.getElementById('pf-oic').innerText || '';
        document.getElementById('edit-pf-contact').value = document.getElementById('pf-contact').innerText || '';
        document.getElementById('edit-profile-modal').style.display = 'flex';
      }
      function closeEditProfileModal(){ document.getElementById('edit-profile-modal').style.display = 'none'; }

      // when user clicks Save in modal, ask confirm first
      function confirmSaveProfileFromModal(){
        if (!confirm('Save profile changes?')) return;
        saveProfileFromModal();
      }

      function saveProfileFromModal(){
        var payload = {
          companyName: document.getElementById('edit-pf-company').value.trim(),
          hqAddress: document.getElementById('edit-pf-addr').value.trim(),
          email: document.getElementById('edit-pf-email').value.trim(),
          oicName: document.getElementById('edit-pf-oic').value.trim(),
          oicContact: document.getElementById('edit-pf-contact').value.trim()
        };
        if (!payload.companyName || !payload.email) { alert('Company name and email are required'); return; }
        showLoading(true);
        google.script.run.withSuccessHandler(function(res){
          showLoading(false);
          if (res.success) { alert('Profile updated'); closeEditProfileModal(); loadUserProfile(false); }
          else alert('Error: ' + (res.message || 'Update failed'));
        }).updateUserProfile(currentUser, payload);
      }

      // Profile history: Orders & My Items
      function loadProfileHistoryOrders(){
        if (!currentUser) {
          document.getElementById('profile-history').innerHTML = "<p class='muted'>Please login.</p>";
          return;
        }
        // set visual active styles (we added CSS .filter-btn.active to match nav active)
        document.getElementById('hist-orders-btn').classList.add('active');
        document.getElementById('hist-items-btn').classList.remove('active');

        var el = document.getElementById('profile-history');
        el.innerHTML = "<p class='muted'>Loading orders...</p>";
        google.script.run.withSuccessHandler(function(items){
          if (!items || items.length===0) { el.innerHTML = "<p class='muted'>No orders found.</p>"; return; }
          var html = "<ul style='list-style:none;padding:0;margin:0;'>";
          items.forEach(function(it){
            html += "<li style='padding:8px;border-bottom:1px solid #f0f0f0;'><strong>"+_escapeHtml(it.orderId||it.code||'')+"</strong> - "+_escapeHtml(it.status||'')+" <div class='muted'>"+(it.createdAt?new Date(it.createdAt).toLocaleString():"")+"</div></li>";
          });
          html += "</ul>";
          el.innerHTML = html;
        }).getUserOrders(currentUser);
      }

      function loadProfileHistoryItems(){
        if (!currentUser) {
          document.getElementById('profile-history').innerHTML = "<p class='muted'>Please login.</p>";
          return;
        }
        document.getElementById('hist-orders-btn').classList.remove('active');
        document.getElementById('hist-items-btn').classList.add('active');
        var el = document.getElementById('profile-history');
        el.innerHTML = "<p class='muted'>Loading items...</p>";
        google.script.run.withSuccessHandler(function(items){
          if (!items || items.length===0) { el.innerHTML = "<p class='muted'>No items found.</p>"; return; }
          var html = "<ul style='list-style:none;padding:0;margin:0;'>";
          items.forEach(function(it){
            html += "<li style='padding:8px;border-bottom:1px solid #f0f0f0;'><strong>"+_escapeHtml(it.code||'')+"</strong> - "+_escapeHtml(it.status||'')+" <div class='muted'>"+(it.uploadedAt?new Date(it.uploadedAt).toLocaleString():"")+"</div></li>";
          });
          html += "</ul>";
          el.innerHTML = html;
        }).getUserItems(currentUser);
      }

      function loadUserHistory(username){
        // kept for compatibility, call loadProfileHistoryOrders
        loadProfileHistoryOrders();
      }

      // ================= Admin console (kept) =================
      function loadAdminConsole(){
        if (userRole !== 'admin') {
          document.getElementById('admin-section').innerHTML = "<p class='muted'>Access denied.</p>";
          return;
        }
        showLoading(true);
        google.script.run.withSuccessHandler(function(threads){
          showLoading(false);
          var out = document.getElementById('admin-threads');
          if (!threads || threads.length===0) out.innerHTML = "<p class='muted'>No threads.</p>";
          else {
            var html = "<ul style='list-style:none;padding:0;'>";
            threads.forEach(function(t){
              html += "<li style='padding:8px;border-bottom:1px solid #f0f0f0;'><strong>"+t.threadId+"</strong> <span class='muted'>last: "+(t.lastAt?new Date(t.lastAt).toLocaleString():"")+"</span> <button onclick='openAdminThread(\""+t.threadId+"\")' class='btn-submit' style='float:right;'>Open</button></li>";
            });
            html += "</ul>";
            out.innerHTML = html;
          }
        }).adminGetThreads();
        google.script.run.withSuccessHandler(function(msgs){
          var el = document.getElementById('admin-messages');
          if (!msgs || msgs.length===0) el.innerHTML = "<p class='muted'>No messages.</p>";
          else {
            var html = "<ul style='list-style:none;padding:0;margin:0;'>";
            msgs.forEach(function(m){
              html += "<li style='padding:8px;border-bottom:1px solid #f0f0f0;'><strong>"+m.fromUser+"</strong> -> "+(m.toUser||'')+" : "+m.message+" <div class='muted'>"+(m.createdAt?new Date(m.createdAt).toLocaleString():"")+"</div></li>";
            });
            html += "</ul>";
            el.innerHTML = html;
          }
        }).getMessages(""); // all messages
      }

      function openAdminThread(threadId){
        google.script.run.withSuccessHandler(function(msgs){
          var html = "<h3>Thread: "+threadId+"</h3><div style='max-height:300px;overflow:auto;background:#fafafa;padding:8px;border-radius:6px;'>";
          msgs.forEach(function(m){
            html += "<div style='padding:6px;border-bottom:1px solid #eee;'><strong>"+m.fromUser+"</strong>: "+m.message+" <div class='muted'>"+(m.createdAt?new Date(m.createdAt).toLocaleString():"")+"</div></div>";
          });
          html += "</div><div style='margin-top:8px;display:flex;gap:8px;'><input id='admin-reply-"+threadId+"' style='flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;'><button class='btn-submit' onclick='adminSendReply(\""+threadId+"\")'>Send</button></div>";
          document.getElementById('admin-messages').innerHTML = html;
        }).getMessages(threadId);
      }

      function adminSendReply(threadId){
        var val = document.getElementById('admin-reply-'+threadId).value;
        if (!val) return;
        google.script.run.withSuccessHandler(function(){ openAdminThread(threadId); }).sendMessage(threadId, "admin", "", val);
      }

      // ================= Help Chat =================
      var currentChatThread = null;
      function openHelpChat(){
        if (!currentUser) {
          alert("Please login to use chat/help.");
          return;
        }
        currentChatThread = "help_" + currentUser;
        document.getElementById('help-modal').style.display = 'flex';
        loadChatMessages();
      }
      function closeHelpChat(){ document.getElementById('help-modal').style.display='none'; }
      function loadChatMessages(){
        if (!currentChatThread) return;
        google.script.run.withSuccessHandler(function(msgs){
          var win = document.getElementById('chat-window');
          win.innerHTML = "";
          msgs.forEach(function(m){
            var cls = m.fromUser === currentUser ? "muted" : "";
            win.innerHTML += "<div style='padding:6px;margin-bottom:6px;border-radius:6px;background:#fff;border:1px solid #eee;'><strong>"+m.fromUser+"</strong>: "+m.message+"<div class='muted' style='font-size:11px;margin-top:4px;'>"+(m.createdAt?new Date(m.createdAt).toLocaleString():"")+"</div></div>";
          });
          win.scrollTop = win.scrollHeight;
        }).getMessages(currentChatThread);
      }
      function sendChatMessage(){
        var txt = document.getElementById('chat-input').value.trim();
        if (!txt) return;
        google.script.run.withSuccessHandler(function(){ document.getElementById('chat-input').value=''; loadChatMessages(); }).sendMessage(currentChatThread, currentUser, "admin", txt);
      }

      // ================= Photo upload & Add Item (existing) =================
      var uploadedPhotos = {}; 
      var requirements = {
          'Shirt': ['Overall Front View', 'Overall Back View', 'Collar', 'Button', 'Cuff', 'Shoulder Flash'],
          'Pants': ['Overall Front View', 'Overall Back View', 'Button & Zipper', 'Trouser Hem']
      };

      function renderPhotoSlots() {
          var cat = document.getElementById('in-cat').value;
          var container = document.getElementById('photo-container');
          container.innerHTML = "";
          uploadedPhotos = {}; 
          
          if(!cat || !requirements[cat]) {
              container.innerHTML = "<p style='color:#888; font-size:13px;'>Please select a Category first.</p>";
              return;
          }
          
          requirements[cat].forEach(function(req, idx){
              var id = 'slot-' + idx;
              var html = `
                <div class="photo-slot" id="div-${id}">
                   <div class="photo-placeholder">${req}</div>
                   <img id="img-${id}">
                   <input type="file" onchange="handleFile(this, '${id}', '${req}')" accept="image/*" style="width:100%; font-size:10px; margin-top:5px;">
                </div>
              `;
              container.innerHTML += html;
          });
      }

      function handleFile(input, id, reqName) {
          if(input.files && input.files[0]) {
              var reader = new FileReader();
              reader.onload = function(e) {
                  document.getElementById('img-'+id).src = e.target.result;
                  document.getElementById('img-'+id).style.display = 'block';
                  document.getElementById('div-'+id).classList.add('done');
                  uploadedPhotos[reqName] = e.target.result;
              };
              reader.readAsDataURL(input.files[0]);
          }
      }

      function submitItem() {
         var cat = document.getElementById('in-cat').value;
         if(typeof uploadedPhotos !== 'undefined' && requirements[cat]) {
            if(Object.keys(uploadedPhotos).length < requirements[cat].length) {
                alert("Warning: Please upload ALL required photos.");
                return;
            }
         }
         
         if(!confirm("Are you sure you want to submit this item?")) return;
         
         showLoading(true);
         
         var formData = {
             category: cat,
             size: document.getElementById('in-size').value,
             type: document.querySelector('input[name="type"]:checked').value,
             price: document.getElementById('in-price').value || "0",
             companyName: document.getElementById('in-comp').value,
             hqAddress: document.getElementById('in-addr').value,
             email: document.getElementById('in-email').value,
             sellerName: document.getElementById('in-name').value,
             oicName: document.getElementById('in-oic').value,
             oicContact: document.getElementById('in-contact').value
         };
         
         google.script.run
             .withSuccessHandler(function(res){
                 showLoading(false);
                 if(res.success) {
                     alert("Item uploaded successfully!");
                     closeAddModal();
                     document.getElementById('add-form').reset();
                     renderPhotoSlots(); 
                     loadInventory(); 
                 } else {
                     alert("Error: " + res.message);
                 }
             })
             .uploadItemToSheet(formData, uploadedPhotos);
      }

      // ================= 9. Auto-Login Check & URL param handling =================
      window.addEventListener('DOMContentLoaded', (event) => {
         // attach Enter key support on login
         _attachEnterLogin();

         // Check URL params for order response
         var params = new URLSearchParams(window.location.search);
         if (params.has('action') && params.get('action') === 'respond' && params.has('orderId')) {
           currentOrderIdFromEmail = params.get('orderId');
           // store to prompt seller after login or show prompt
         }

         const loggedIn = sessionStorage.getItem('isLoggedIn'); 
         if (loggedIn === 'true') {
             currentUser = sessionStorage.getItem('currentUser');
             userRole = sessionStorage.getItem('role');
             
             document.getElementById('login-view').style.display = 'none';
             document.getElementById('dashboard-view').style.display = 'block';
             if (userRole === 'admin') document.getElementById('nav-admin').style.display = 'inline-block';
             // restore tab
             var last = sessionStorage.getItem('currentTab') || 'home';
             switchTab(last);

             // If came from email with orderId, attempt to open response modal
             if (currentOrderIdFromEmail) {
               showLoading(true);
               google.script.run.withSuccessHandler(function(order){
                 showLoading(false);
                 if (!order) {
                   alert("Order not found or invalid.");
                   return;
                 }
                 showLoading(true);
                 google.script.run.withSuccessHandler(function(item){
                   showLoading(false);
                   var proceed = confirm("You have an order to respond for item " + order.itemCode + ". Do you want to respond now?");
                   if (!proceed) return;
                   var ans = confirm("Click OK for Yes (available) or Cancel for No (not available).");
                   var resp = ans ? "Yes" : "No";
                   var final = confirm("Are you sure you want to choose: " + resp + " ?");
                   if (!final) return;
                   showLoading(true);
                   google.script.run.withSuccessHandler(function(r){
                     showLoading(false);
                     if (r && r.success) {
                       alert("Response recorded. Thank you.");
                       // reload inventory
                       loadInventory();
                     } else {
                       alert("Failed: " + (r.message || "unknown"));
                     }
                   }).recordSellerResponse(order.orderId, resp);
                 }).getItemDetails(order.itemCode);
               }).getOrderForResponse(currentOrderIdFromEmail);
             }
         } else {
             document.getElementById('login-view').style.display = 'flex';
             document.getElementById('dashboard-view').style.display = 'none';
         }

         // profile menu: close when clicking outside
         document.addEventListener('click', function(e){
           var menu = document.getElementById('profile-menu');
           var btn = document.getElementById('profile-menu-btn');
           if (!menu) return;
           if (btn && (btn.contains(e.target) || menu.contains(e.target))) return;
           menu.style.display = 'none';
         });

      });

      // ================= Utility functions =================
      function openAddModal() { 
        // when opening add modal, pre-fill personal info from profile if logged in
        if (currentUser) {
          showLoading(true);
          google.script.run.withSuccessHandler(function(profile){
            showLoading(false);
            if (profile) {
              // only fill fields that are empty or equal previous cached profile
              syncProfileToForms(profile);
            }
            document.getElementById('add-modal').style.display = 'flex';
          }).getUserProfile(currentUser);
        } else {
          document.getElementById('add-modal').style.display = 'flex';
        }
      }
      function closeAddModal() { document.getElementById('add-modal').style.display = 'none'; }

      function toggleProfileMenu() {
        var m = document.getElementById('profile-menu');
        if (!m) return;
        m.style.display = (m.style.display === 'block') ? 'none' : 'block';
      }

      // Logout with confirmation
      function logout(){
        if (!confirm('Are you sure you want to log out?')) return;
        sessionStorage.removeItem('isLoggedIn');
        sessionStorage.removeItem('currentUser');
        sessionStorage.removeItem('role');
        currentUser = "";
        userRole = "";
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('login-view').style.display = 'flex';
        // clear some UI
        document.getElementById('password').value = '';
      }

      // Change password flow (for logged-in user): verify current password via modal then call changeUserPassword
      function openChangePasswordModal(){
        if (!currentUser) {
          alert('Please login first.');
          return;
        }
        // open verify modal (replaces prompt)
        document.getElementById('verify-error').style.display = 'none';
        document.getElementById('verify-current-input').value = '';
        document.getElementById('verify-current-modal').style.display = 'flex';
      }
      function closeChangePasswordModal(){
        // clear verification flags
        window._currentPasswordVerified = false;
        window._currentPasswordValue = "";
        // ensure cur-password visible again for future flows
        document.getElementById('cur-password').style.display = 'block';
        document.getElementById('change-password-modal').style.display = 'none';
      }

      function closeVerifyModal(){
        document.getElementById('verify-current-modal').style.display = 'none';
      }

      function submitVerifyCurrent(){
        var curVal = document.getElementById('verify-current-input').value || '';
        var err = document.getElementById('verify-error');
        err.style.display = 'none';
        if (!curVal) { err.textContent = 'Please enter current password'; err.style.display = 'block'; return; }
        showLoading(true);
        google.script.run.withSuccessHandler(function(vres){
          showLoading(false);
          if (vres && vres.success) {
            // verified: set flags, close verify modal, open change modal with current password hidden (internal)
            window._currentPasswordVerified = true;
            window._currentPasswordValue = curVal;
            closeVerifyModal();
            // hide current input in change modal and set value (so change function can use it if needed)
            document.getElementById('cur-password').value = curVal;
            document.getElementById('cur-password').style.display = 'none';
            document.getElementById('change-pw-error').style.display = 'none';
            document.getElementById('cur-new-password').value = '';
            document.getElementById('cur-confirm-password').value = '';
            document.getElementById('change-password-modal').style.display = 'flex';
          } else {
            err.textContent = vres && vres.message ? vres.message : 'Current password incorrect';
            err.style.display = 'block';
          }
        }).verifyUserPassword(currentUser, curVal);
      }

      function changePasswordWithCurrent(){
        var cur = document.getElementById('cur-password').value || '';
        var np = document.getElementById('cur-new-password').value || '';
        var conf = document.getElementById('cur-confirm-password').value || '';
        var err = document.getElementById('change-pw-error');
        err.style.display = 'none';

        if (!cur) { err.textContent = 'Please enter current password'; err.style.display = 'block'; return; }
        if (np.length < 7) { err.textContent = 'New password must be at least 7 characters'; err.style.display = 'block'; return; }
        if (!/\d/.test(np)) { err.textContent = 'New password must contain at least one number'; err.style.display = 'block'; return; }
        if (np !== conf) { err.textContent = 'Passwords do not match'; err.style.display = 'block'; return; }

        showLoading(true);

        // If already pre-verified earlier, skip re-verifying current password; otherwise verify on server
        if (window._currentPasswordVerified && window._currentPasswordValue === cur) {
          // Already verified; directly change password
          google.script.run.withSuccessHandler(function(chres){
            showLoading(false);
            if (chres && chres.success) {
              alert('Password changed successfully.');
              // Close modal and clear flags — do NOT force logout per requirement
              closeChangePasswordModal();
            } else {
              err.textContent = chres && chres.message ? chres.message : 'Failed to change password';
              err.style.display = 'block';
            }
            // clear verification
            window._currentPasswordVerified = false;
            window._currentPasswordValue = "";
          }).changeUserPassword(currentUser, np);
        } else {
          // Not pre-verified: verify current password first
          google.script.run.withSuccessHandler(function(vres){
            if (!vres || !vres.success) {
              showLoading(false);
              err.textContent = vres && vres.message ? vres.message : 'Current password is incorrect';
              err.style.display = 'block';
              return;
            }
            // verified now, call change
            google.script.run.withSuccessHandler(function(chres){
              showLoading(false);
              if (chres && chres.success) {
                alert('Password changed successfully.');
                // Close modal and clear flags — do NOT force logout
                closeChangePasswordModal();
              } else {
                err.textContent = chres && chres.message ? chres.message : 'Failed to change password';
                err.style.display = 'block';
              }
            }).changeUserPassword(currentUser, np);
          }).withFailureHandler(function(){
            showLoading(false);
            err.textContent = 'Failed to verify current password';
            err.style.display = 'block';
          }).verifyUserPassword(currentUser, cur);
        }
      }

      // Small helper: getUserOrders (called server-side)
      // No client implementation needed here; server provides getUserOrders()

    </script>
  </body>
</html>
